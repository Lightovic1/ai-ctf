<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>AI Prompt-CTF - Game</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 1rem; }
      #topbar { display:flex; gap:20px; align-items:center; flex-wrap:wrap; }
      #chat { border: 1px solid #ddd; padding: 1rem; height: 420px; overflow-y: auto; background:#f9f9f9; display:flex; flex-direction:column;}
      .msg { margin: 0.5rem 0; padding:0.4rem; border-radius:6px; max-width:86%; }
      .bot { color: #003366; background:#eef6ff; align-self:flex-start; }
      .you { color: #065; background:#efffe8; align-self:flex-end; margin-left: auto; }
      #leaderboard { margin-top: 1rem; border-top:1px solid #ddd; padding-top:10px; }
      #stats { color:#333; }
    </style>
  </head>
  <body>
    <div id="topbar">
      <h2>Welcome, {{ player_name }} â€” Model: {{ model_name }}</h2>
      <div>Time left: <span id="timer">--:--</span></div>
      <div id="stats">Stats: loadingâ€¦</div>
    </div>

    <div style="margin: 8px 0;">
      <label>Select Level:
        <select id="level">
          {% for l in levels %}
            <option value="{{l}}">Level {{l}}</option>
          {% endfor %}
        </select>
      </label>
    </div>

    <div id="chat"></div>

    <form id="sendForm" onsubmit="sendPrompt(event)" style="margin-top:10px;">
      <input id="prompt" style="width:72%" placeholder="Talk to the model..." autocomplete="off" required>
      <button type="submit">Send</button>
    </form>

    <h3>Leaderboard (players who have solved at least one level)</h3>
    <div id="leaderboard">Loading...</div>

    <script>
      let timerSec = {{ time_remaining }};
      function fmt(s){
        let m = Math.floor(s/60), sec=s%60;
        return String(m).padStart(2,'0') + ":" + String(sec).padStart(2,'0');
      }
      function tick(){
        if (timerSec>0) timerSec--;
        document.getElementById('timer').innerText = fmt(timerSec);
        if (timerSec<=0) {
          appendBot("Time's up â€” your session expired.");
          document.getElementById('sendForm').style.display = 'none';
        }
      }
      setInterval(tick, 1000);
      document.getElementById('timer').innerText = fmt(timerSec);

      function appendBot(text){
        let d = document.createElement('div'); d.className='msg bot'; d.innerText = "MODEL: " + text;
        document.getElementById('chat').appendChild(d);
        document.getElementById('chat').scrollTop = 99999;
      }
      function appendYou(text){
        let d = document.createElement('div'); d.className='msg you'; d.innerText = "YOU: " + text;
        document.getElementById('chat').appendChild(d);
        document.getElementById('chat').scrollTop = 99999;
      }

      // initial model intro (human-like)
      appendBot("Hey there! Iâ€™m {{model_name}}. Your mission is simple: get the secret key for the selected level by asking me the right way. Start with Level 1 â€” be explicit and polite; I warm up fast.");

      async function fetchLeaderboard(){
        try{
          let r = await fetch('/leaderboard');
          let j = await r.json();
          if (!j || j.length===0) {
            document.getElementById('leaderboard').innerHTML = "<i>No successful players yet â€” be the first!</i>";
            return;
          }
          let html = "<ol>";
          j.forEach(x => {
            html += `<li>${x.name} - Level ${x.level} at ${x.time}</li>`;
          });
          html += "</ol>";
          document.getElementById('leaderboard').innerHTML = html;
        } catch(e){
          document.getElementById('leaderboard').innerHTML = "<i>Leaderboard unavailable.</i>";
        }
      }
      fetchLeaderboard();
      setInterval(fetchLeaderboard, 10000);

      async function refreshStats(){
        try{
          const r = await fetch('/stats');
          const j = await r.json();
          document.getElementById('stats').innerText =
            `Stats: Registered ${j.registered} | Active ${j.active} | Solvers ${j.solvers}`;
        } catch(e){
          document.getElementById('stats').innerText = "Stats: unavailable";
        }
      }
      refreshStats();
      setInterval(refreshStats, 5000);

      async function sendPrompt(e){
        e.preventDefault();
        let prompt = document.getElementById('prompt').value;
        let level = document.getElementById('level').value;
        appendYou(prompt);
        document.getElementById('prompt').value = "";
        let r = await fetch('/chat', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({prompt: prompt, level: level})
        });
        let j = await r.json();
        if (j.error) { appendBot("ERROR: " + j.error); return; }
        if (j.status === "timeout") { appendBot(j.message); return; }
        if (j.success){
          let win = j.winmsg || "Nice work!";
          appendBot(win + " ðŸŽ‰");
          appendBot("You revealed: " + j.reveal);
          fetchLeaderboard();
          refreshStats();
        } else {
          let reply = j.reply || "That didnâ€™t work. Try a clearer ask.";
          appendBot(reply);
          appendBot("(aside) " + (j.taunt || "Keep at it."));
        }
      }
    </script>
  </body>
</html>
