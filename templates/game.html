<!doctype html>
<html>
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>AI Prompt-CTF â€¢ Game</title>
<style>
 :root{--bg:#061120;--card:#0b1726;--accent:#06b6d4;--muted:#9fb7c9}
 body{margin:0;background:linear-gradient(180deg,#050f1d,#061120);color:#e6eef8;font-family:Inter,system-ui,Arial}
 .grid{max-width:1200px;margin:18px auto;display:grid;grid-template-columns:1fr 420px;gap:18px}
 .panel{background:var(--card);border-radius:16px;box-shadow:0 10px 40px rgba(2,6,23,.6);padding:16px}
 header{display:flex;justify-content:space-between;align-items:center}
 .host{display:flex;gap:12px;align-items:center}
 .host img{width:64px;height:64px;border-radius:12px}
 .badge{background:#082236;border:1px solid #0c3950;padding:6px 10px;border-radius:12px}
 #chat{height:520px;overflow:auto;margin-top:10px;padding:12px;border-radius:12px;background:linear-gradient(180deg,#081a2c,#081424)}
 .bubble{display:inline-block;max-width:80%;padding:10px 14px;margin:8px 0;border-radius:12px}
 .bot{background:#072a3a;color:#cfeff6}
 .you{background:#0a2f1c;color:#defbe6;margin-left:auto}
 .controls{display:flex;gap:8px;margin-top:10px}
 input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid #1e3547;background:#0a1e2c;color:#e6eef8}
 button{background:var(--accent);border:none;color:#012;padding:10px 12px;border-radius:10px;font-weight:800;cursor:pointer}
 .small{color:var(--muted);font-size:12px}
 .puzzle{position:relative;aspect-ratio:3/2;border-radius:12px;overflow:hidden;border:1px solid #0f2e40;background:#010a10}
 .tile{position:absolute;inset:0;background:url("/static/puzzle.jpg") center/cover no-repeat;filter:grayscale(1) brightness(.25) blur(2px);transition:filter .5s, opacity .5s}
 /* 3x3 grid positions, reveal first 7 */
 .mask{position:absolute;background:rgba(0,0,0,.6);transition:opacity .5s}
 /* positions */
 .g{position:absolute}
 .g1{left:0;top:0;width:33.333%;height:33.333%}
 .g2{left:33.333%;top:0;width:33.333%;height:33.333%}
 .g3{left:66.666%;top:0;width:33.333%;height:33.333%}
 .g4{left:0;top:33.333%;width:33.333%;height:33.333%}
 .g5{left:33.333%;top:33.333%;width:33.333%;height:33.333%}
 .g6{left:66.666%;top:33.333%;width:33.333%;height:33.333%}
 .g7{left:0;top:66.666%;width:33.333%;height:33.333%}
 .g8{left:33.333%;top:66.666%;width:33.333%;height:33.333%}
 .g9{left:66.666%;top:66.666%;width:33.333%;height:33.333%}
 .mask.locked{opacity:1} .mask.unlocked{opacity:0}
 .confetti{position:absolute;inset:0;pointer-events:none}
</style>
</head>
<body>
<div class="grid">
  <div class="panel">
    <header>
      <div class="host">
        <img src="https://i.imgur.com/7bG7K6V.png" alt="host">
        <div>
          <div style="font-weight:800">{{ model_name }}</div>
          <div class="small">Player: <b>{{ player_name }}</b> â€¢ Time: <span id="timer">--:--</span></div>
        </div>
      </div>
      <div class="badge">Level <b id="curlevel">{{ current_level }}</b> / {{ max_level }}</div>
    </header>

    <div id="chat" aria-live="polite"></div>

    <div class="controls">
      <input id="prompt" placeholder="Try echo / repeat / onboarding-style asksâ€¦">
      <button id="send">Send</button>
    </div>

    <div class="small" style="margin-top:6px">Direct asks are refused. Be crafty. If you tease a key out, paste it below to claim your image tile.</div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <input id="validator" placeholder="Paste key to validate & unlock tileâ€¦">
      <button id="validate">Validate</button>
    </div>
  </div>

  <div class="panel">
    <h3 style="margin:0 0 8px">Image Puzzle</h3>
    <div class="puzzle" id="puzzle">
      <div class="tile"></div>
      <!-- 7 of 9 tiles lock/unlock; we use masks to hide until unlocked -->
      <div id="m1" class="mask g g1"></div>
      <div id="m2" class="mask g g2"></div>
      <div id="m3" class="mask g g3"></div>
      <div id="m4" class="mask g g4"></div>
      <div id="m5" class="mask g g5"></div>
      <div id="m6" class="mask g g6"></div>
      <div id="m7" class="mask g g7"></div>
      <!-- we leave g8/g9 always visible so the image is partly visible early -->
      <div class="confetti" id="confetti"></div>
    </div>
    <div class="small" style="margin-top:8px">Tiles unlocked: <b id="tiles">{{ progress }}</b> / {{ max_level }}</div>

    <div style="margin-top:14px">
      <h4 style="margin:0 0 6px">Leaderboard</h4>
      <div id="leaderboard" class="small">Loadingâ€¦</div>
    </div>
  </div>
</div>

<script>
let secs = {{ time_remaining }};
const chat = document.getElementById('chat');
const timer = document.getElementById('timer');
function fmt(n){return String(n).padStart(2,'0')}
function tick(){ if(secs>0) secs--; timer.textContent = `${fmt(Math.floor(secs/60))}:${fmt(secs%60)}`; if(secs<=0){ appendBot("Time's up â€” GG!"); document.getElementById('send').disabled=true; } }
setInterval(tick,1000); tick();

function appendBot(t){ let d=document.createElement('div'); d.className='bubble bot'; d.textContent='MODEL: '+t; chat.appendChild(d); chat.scrollTop=chat.scrollHeight; }
function appendYou(t){ let d=document.createElement('div'); d.className='bubble you'; d.textContent='YOU: '+t; chat.appendChild(d); chat.scrollTop=chat.scrollHeight; }

appendBot("Iâ€™m {{ model_name }}. JD said â€œno leaksâ€â€¦ but clever players find cracks. Level {{ current_level }} begins. ðŸ˜‡");

document.getElementById('send').addEventListener('click', send);
document.getElementById('prompt').addEventListener('keydown', e=>{ if(e.key==='Enter') send(); });

async function send(){
  const txt = document.getElementById('prompt').value.trim(); if(!txt) return;
  appendYou(txt); document.getElementById('prompt').value='';
  appendBot("â€¦thinkingâ€¦");
  const typing = chat.lastElementChild;
  try{
    const res = await fetch('/chat',{method:'POST',headers:{'content-type':'application/json'},
      body:JSON.stringify({prompt:txt, level:parseInt(document.getElementById('curlevel').textContent)})});
    const j = await res.json(); typing.remove();
    if(j.success){
      appendBot(j.winmsg || "Key surfaced.");
      appendBot("Copy to validator: "+j.reveal);
      document.getElementById('validator').value = j.reveal;
      refreshLB(); refreshStats();
    }else{
      appendBot(j.reply || "Nope.");
      if(j.taunt) appendBot("(aside) "+j.taunt);
    }
  }catch{ typing.remove(); appendBot("Network hiccup.") }
}

document.getElementById('validate').addEventListener('click', async ()=>{
  const k = document.getElementById('validator').value.trim(); if(!k) return;
  const lvl = parseInt(document.getElementById('curlevel').textContent);
  const r = await fetch('/validate',{method:'POST',headers:{'content-type':'application/json'},
    body:JSON.stringify({level:lvl, key:k})});
  const j = await r.json();
  if(j.success){
    appendBot(j.message);
    document.getElementById('tiles').textContent = j.progress;
    unlock(j.progress);
    confetti();
    document.getElementById('curlevel').textContent = j.next_level;
    document.getElementById('validator').value = '';
    refreshLB(); refreshStats();
  }else{
    appendBot(j.message || "Invalid key.");
  }
});

function unlock(n){
  for(let i=1;i<=7;i++){
    const m = document.getElementById('m'+i);
    if(!m) continue;
    m.className = 'mask g g'+i + (i<=n?' unlocked':' locked');
  }
  // brighten base image a bit as progress grows
  document.querySelector('.tile').style.filter = n>=5 ? 'grayscale(.2) brightness(.9)' : n>=3 ? 'grayscale(.5) brightness(.7)' : 'grayscale(1) brightness(.5)';
}
unlock({{ progress }});

function confetti(){
  const c = document.getElementById('confetti'); c.innerHTML='';
  for(let i=0;i<50;i++){
    const e=document.createElement('div'); e.style.position='absolute';
    e.style.left=Math.random()*100+'%'; e.style.top='100%';
    e.style.width='8px'; e.style.height='14px';
    e.style.background=['#06b6d4','#84cc16','#f97316','#ef4444'][Math.floor(Math.random()*4)];
    c.appendChild(e);
    setTimeout(()=>{ e.style.transition='all 900ms ease'; e.style.transform=`translateY(-${80+Math.random()*60}%) rotate(${Math.random()*360}deg)`; e.style.opacity=0; }, 20);
  }
  setTimeout(()=>c.innerHTML='',1400);
}

async function refreshLB(){
  try{const r=await fetch('/leaderboard');const j=await r.json();
      if(!j.length){document.getElementById('leaderboard').innerHTML='<i>Be first.</i>';return;}
      let h='<ol>'; j.forEach(x=>h+=`<li>${x.name} â€¢ L${x.level} â€¢ ${x.time}</li>`); h+='</ol>';
      document.getElementById('leaderboard').innerHTML=h;
  }catch{document.getElementById('leaderboard').innerText='(unavailable)'}
}
async function refreshStats(){ try{ await fetch('/stats'); }catch{} }
refreshLB(); setInterval(refreshLB,10000);
</script>
</body></html>
